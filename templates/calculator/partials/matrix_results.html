{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if results %}
<div class="card">
    <div class="card-body">
        <h5 class="card-title">Результат розрахунку</h5>
        <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>Граничне значення L*:</strong> {{ results.L_star }}</li>
            <li class="list-group-item"><strong>Контрольований стан:</strong> 
                {% if results.controlled_state == 0 %}L1{% else %}L2{% endif %}
            </li>
            <li class="list-group-item"><strong>Мінімальне значення неконтрольованого стану J:</strong> {{ results.best_J }}</li>
            <li class="list-group-item"><strong>Опис рішення:</strong> {{ results.best_desc }}</li>
            <li class="list-group-item"><strong>Ймовірності стратегій:</strong>
                <ul>
                    {% for name, prob in results.best_solution.items %}
                    <li>{{ name }}: {{ prob }}</li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </div>
</div>

<div class="mt-4" style="min-height: 420px; position: relative;">
    <canvas id="strategyChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('strategyChart').getContext('2d');

    const strategies = {{ results.strategies|safe }};
    const controlled_state = {{ results.controlled_state }};
    const L_star = {{ results.L_star }};
    const best_solution = {{ results.best_solution|safe }};

    // Разделяем L и J по контролируемому состоянию
    const L_values = [];
    const J_values = [];
    const labels = [];

    Object.entries(strategies).forEach(([name, pair]) => {
        L_values.push(pair[controlled_state]);
        J_values.push(pair[1 - controlled_state]);
        labels.push(name);
    });

    // Определим точки выбранных стратегий
    const chosen_points = [];
    for (const [name, prob] of Object.entries(best_solution)) {
        if (prob > 0) {
            chosen_points.push({
                label: name,
                L: strategies[name][controlled_state],
                J: strategies[name][1 - controlled_state]
            });
        }
    }

    const data = {
        labels: labels,
        datasets: [
            {
                label: 'Стратегії',
                data: L_values.map((v, i) => ({x: L_values[i], y: J_values[i]})),
                backgroundColor: 'black',
                pointRadius: 5,
                type: 'scatter'
            },
            {
                label: 'Обрані стратегії',
                data: chosen_points.map(p => ({x: p.L, y: p.J})),
                backgroundColor: 'red',
                pointRadius: 8,
                type: 'scatter'
            },
            {
                label: 'Граничне L*',
                data: controlled_state === 0
                    ? [{x: L_star, y: Math.min(...J_values)}, {x: L_star, y: Math.max(...J_values)}]
                    : [{x: Math.min(...L_values), y: L_star}, {x: Math.max(...L_values), y: L_star}],
                borderColor: 'red',
                borderWidth: 2,
                fill: false,
                showLine: true,
                type: 'line',
                pointRadius: 0,
                borderDash: [10,5]
            },
            {
                label: 'Відрізок оптимальних стратегій',
                data: chosen_points.length === 2
                    ? [
                        {x: chosen_points[0].L, y: chosen_points[0].J},
                        {x: chosen_points[1].L, y: chosen_points[1].J}
                    ]
                    : [],
                borderColor: 'green',
                borderWidth: 3,
                fill: false,
                showLine: true,
                type: 'line',
                pointRadius: 0
            }
        ]
    };

    if (window.strategyChart) {
        window.strategyChart.destroy();
    }

    window.strategyChart = new Chart(ctx, {
        type: 'scatter',
        data: data,
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: controlled_state === 0 ? 'L1' : 'L2'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: controlled_state === 0 ? 'J (L2)' : 'J (L1)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Пошук оптимальних стратегій'
                }
            }
        }
    });
});
</script>
{% endif %}
