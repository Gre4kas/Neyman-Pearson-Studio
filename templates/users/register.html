{% extends "base.html" %}

{% block title %}Реєстрація{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">Створити аккаунт</h2>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}

                    <!-- Username field -->
                    <div class="mb-3">
                        <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }}</label>
                        {{ form.username }}
                        {% for error in form.username.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <!-- Email field -->
                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                        {{ form.email }}
                        {% for error in form.email.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <!-- Password1 field with validation hints -->
                    <div class="mb-3">
                        <label for="{{ form.password1.id_for_label }}" class="form-label">{{ form.password1.label }}</label>
                        <div class="input-group">
                            {{ form.password1 }}
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword1">
                                <i class="fas fa-eye" id="eyeIcon1"></i>
                            </button>
                        </div>
                        
                        <!-- Password validation hints -->
                        <div class="mt-2" id="passwordHints">
                            <small class="d-block">
                                <i class="fas fa-times text-danger" id="similarityIcon"></i>
                                <span id="similarityHint" class="text-danger">Your password can't be too similar to your other personal information.</span>
                            </small>
                            <small class="d-block">
                                <i class="fas fa-times text-danger" id="lengthIcon"></i>
                                <span id="lengthHint" class="text-danger">Your password must contain at least 8 characters.</span>
                            </small>
                            <small class="d-block">
                                <i class="fas fa-times text-danger" id="commonIcon"></i>
                                <span id="commonHint" class="text-danger">Your password can't be a commonly used password.</span>
                            </small>
                            <small class="d-block">
                                <i class="fas fa-times text-danger" id="numericIcon"></i>
                                <span id="numericHint" class="text-danger">Your password can't be entirely numeric.</span>
                            </small>
                        </div>

                        {% for error in form.password1.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <!-- Password2 field (confirmation) -->
                    <div class="mb-3">
                        <label for="{{ form.password2.id_for_label }}" class="form-label">{{ form.password2.label }}</label>
                        <div class="input-group">
                            {{ form.password2 }}
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword2">
                                <i class="fas fa-eye" id="eyeIcon2"></i>
                            </button>
                        </div>
                        {% for error in form.password2.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Зареєструватися</button>
                </form>
            </div>
            <div class="card-footer text-center">
                <small>Уже есть аккаунт? <a href="{% url 'users:login' %}">Увійти</a></small>
            </div>
        </div>
    </div>
</div>

<style>
.password-hint-valid {
    color: #28a745 !important;
}

.password-hint-invalid {
    color: #dc3545 !important;
}

#passwordHints small {
    margin-bottom: 4px;
}

#passwordHints i {
    margin-right: 8px;
    width: 14px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Common passwords list (simplified)
    const commonPasswords = [
        'password', '123456', '123456789', 'qwerty', 'abc123', 'password123',
        '1234567', 'welcome', 'admin', 'login', '123123', 'letmein',
        'monkey', '1234567890', 'dragon', 'princess', 'sunshine', 'master'
    ];

    // Toggle password visibility
    function setupPasswordToggle(toggleId, passwordId, eyeIconId) {
        const toggle = document.getElementById(toggleId);
        const password = document.getElementById(passwordId);
        const eyeIcon = document.getElementById(eyeIconId);

        if (toggle && password && eyeIcon) {
            toggle.addEventListener('click', function() {
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                
                if (type === 'text') {
                    eyeIcon.classList.remove('fa-eye');
                    eyeIcon.classList.add('fa-eye-slash');
                } else {
                    eyeIcon.classList.remove('fa-eye-slash');
                    eyeIcon.classList.add('fa-eye');
                }
            });
        }
    }

    // Set up password toggles
    setupPasswordToggle('togglePassword1', 'id_password1', 'eyeIcon1');
    setupPasswordToggle('togglePassword2', 'id_password2', 'eyeIcon2');

    // Password validation
    const passwordInput = document.getElementById('id_password1');
    const usernameInput = document.getElementById('id_username');
    const emailInput = document.getElementById('id_email');

    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const username = usernameInput ? usernameInput.value : '';
            const email = emailInput ? emailInput.value : '';

            validatePassword(password, username, email);
        });
    }

    function validatePassword(password, username, email) {
        // Check similarity to personal information
        validateSimilarity(password, username, email);
        
        // Check length
        validateLength(password);
        
        // Check if common password
        validateCommonPassword(password);
        
        // Check if entirely numeric
        validateNumeric(password);
    }

    function validateSimilarity(password, username, email) {
        const similarityIcon = document.getElementById('similarityIcon');
        const similarityHint = document.getElementById('similarityHint');
        
        let isSimilar = false;
        
        if (password.length > 0) {
            const passwordLower = password.toLowerCase();
            const usernameLower = username.toLowerCase();
            const emailLower = email.split('@')[0].toLowerCase(); // Get email prefix
            
            // Check if password contains username or email prefix
            if ((username.length > 0 && passwordLower.includes(usernameLower)) ||
                (email.length > 0 && passwordLower.includes(emailLower))) {
                isSimilar = true;
            }
        }
        
        updateHintStatus(similarityIcon, similarityHint, !isSimilar && password.length > 0);
    }

    function validateLength(password) {
        const lengthIcon = document.getElementById('lengthIcon');
        const lengthHint = document.getElementById('lengthHint');
        
        const isValid = password.length >= 8;
        updateHintStatus(lengthIcon, lengthHint, isValid);
    }

    function validateCommonPassword(password) {
        const commonIcon = document.getElementById('commonIcon');
        const commonHint = document.getElementById('commonHint');
        
        const isCommon = commonPasswords.includes(password.toLowerCase());
        updateHintStatus(commonIcon, commonHint, !isCommon && password.length > 0);
    }

    function validateNumeric(password) {
        const numericIcon = document.getElementById('numericIcon');
        const numericHint = document.getElementById('numericHint');
        
        const isEntirelyNumeric = /^\d+$/.test(password);
        updateHintStatus(numericIcon, numericHint, !isEntirelyNumeric && password.length > 0);
    }

    function updateHintStatus(icon, hint, isValid) {
        if (isValid) {
            icon.classList.remove('fa-times', 'text-danger');
            icon.classList.add('fa-check', 'text-success');
            hint.classList.remove('text-danger');
            hint.classList.add('text-success');
        } else {
            icon.classList.remove('fa-check', 'text-success');
            icon.classList.add('fa-times', 'text-danger');
            hint.classList.remove('text-success');
            hint.classList.add('text-danger');
        }
    }
});
</script>
{% endblock %}
